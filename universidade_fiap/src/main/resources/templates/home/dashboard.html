<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragmentos :: cabecalho('Dashboard')}" />

<body>
    <form th:replace="~{fragmentos :: form-logout}" />

    <div class="container py-4">
        <div th:replace="~{fragmentos :: saudacoes(${usuario_logado})}" />

        <!-- Header com bot√£o voltar -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">Dashboard</h1>
                    <a href="/index" class="btn btn-secondary btn-custom">
                        <i class="fas fa-arrow-left me-1"></i>Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- M√©tricas principais -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Total de Motos</h5>
                        <p class="card-text fs-4" th:text="${totalMotos}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Prontas</h5>
                        <p class="card-text fs-4" th:text="${motosProntas}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Alugadas</h5>
                        <p class="card-text fs-4" th:text="${motosAlugadas}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Em Manuten√ß√£o</h5>
                        <p class="card-text fs-4" th:text="${motosEmManutencao}">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status adicionais -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Pendentes</h5>
                        <p class="card-text fs-4" th:text="${motosPendentes}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-secondary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Sem Placa</h5>
                        <p class="card-text fs-4" th:text="${motosSemPlaca}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Aguardando Aluguel</h5>
                        <p class="card-text fs-4" th:text="${motosAguardandoAluguel}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-dark text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Status</h5>
                        <p class="card-text fs-4" th:text="${totalStatus}">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Detec√ß√£o de Motos em Tempo Real -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Detec√ß√£o de Motos em Tempo Real
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Mapa Visual -->
                                <div class="mb-3">
                                    <h6>üó∫Ô∏è Mapa de Detec√ß√£o (640x480 pixels)</h6>
                                    <div id="mapaDetecao" style="position: relative; width: 640px; height: 480px; border: 2px solid #333; background: linear-gradient(45deg, #e8f5e8, #f0f8f0); border-radius: 8px; overflow: hidden; margin: 0 auto;">
                                        <!-- Zonas -->
                                        <div style="position: absolute; top: 10px; left: 10px; width: 200px; height: 80px; border: 2px dashed #28a745; background: rgba(40, 167, 69, 0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #28a745; font-size: 12px; text-align: center;">
                                            ENTRADA<br><small>(10,10)-(210,90)</small>
                                        </div>
                                        <div style="position: absolute; top: 10px; right: 10px; width: 200px; height: 80px; border: 2px dashed #dc3545; background: rgba(220, 53, 69, 0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #dc3545; font-size: 12px; text-align: center;">
                                            SA√çDA<br><small>(430,10)-(630,90)</small>
                                        </div>
                                        <div style="position: absolute; bottom: 10px; left: 10px; width: 300px; height: 120px; border: 2px dashed #007bff; background: rgba(0, 123, 255, 0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #007bff; font-size: 12px; text-align: center;">
                                            ESTACIONAMENTO<br><small>(10,350)-(310,470)</small>
                                        </div>
                                        <div style="position: absolute; bottom: 10px; right: 10px; width: 200px; height: 120px; border: 2px dashed #ffc107; background: rgba(255, 193, 7, 0.1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #ffc107; font-size: 12px; text-align: center;">
                                            MANUTEN√á√ÉO<br><small>(440,350)-(640,470)</small>
                                        </div>
                                        <!-- Coordenadas -->
                                        <div id="coordenadasMapa" style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">
                                            X: 0, Y: 0
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tabela de Eventos -->
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Evento</th>
                                                <th>Posi√ß√£o</th>
                                                <th>Zona</th>
                                                <th>Hor√°rio</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eventTableBody">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">
                                                    Aguardando eventos de detec√ß√£o...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">üìä Estat√≠sticas</h6>
                                        <p class="card-text">
                                            <strong>Total de Eventos:</strong> <span id="totalEvents">0</span>
                                        </p>
                                        <p class="card-text">
                                            <strong>√öltima Atualiza√ß√£o:</strong> <span id="lastUpdate">-</span>
                                        </p>
                                        <hr>
                                        <h6 class="card-title">üéØ Por Zona</h6>
                                        <p class="card-text">
                                            <span class="badge bg-success">Entrada:</span> <span id="entradaCount">0</span>
                                        </p>
                                        <p class="card-text">
                                            <span class="badge bg-danger">Sa√≠da:</span> <span id="saidaCount">0</span>
                                        </p>
                                        <p class="card-text">
                                            <span class="badge bg-primary">Estacionamento:</span> <span id="estacionamentoCount">0</span>
                                        </p>
                                        <p class="card-text">
                                            <span class="badge bg-warning">Manuten√ß√£o:</span> <span id="manutencaoCount">0</span>
                                        </p>
                                        <hr>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="loadEvents()">
                                                <i class="fas fa-sync-alt me-1"></i>Atualizar
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="toggleAutoRefresh()">
                                                <i class="fas fa-play me-1"></i><span id="autoRefreshText">Auto Atualizar</span>
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <a href="/mapa_simples.html" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-map me-1"></i>Mapa Completo
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

    <script>
        let autoRefreshInterval;
        let isAutoRefreshEnabled = false;
        let deteccoesVisuais = [];

        function determinarZona(x, y) {
            if (x >= 10 && x <= 210 && y >= 10 && y <= 90) return 'Entrada';
            if (x >= 430 && x <= 630 && y >= 10 && y <= 90) return 'Sa√≠da';
            if (x >= 10 && x <= 310 && y >= 350 && y <= 470) return 'Estacionamento';
            if (x >= 440 && x <= 640 && y >= 350 && y <= 470) return 'Manuten√ß√£o';
            return 'Indefinida';
        }

        function adicionarDeteccaoVisual(x, y, tipo) {
            const mapa = document.getElementById('mapaDetecao');
            if (!mapa) {
                console.error('‚ùå Mapa n√£o encontrado!');
                return;
            }
            
            // Remove detec√ß√µes antigas da mesma posi√ß√£o
            const deteccoesExistentes = mapa.querySelectorAll('.deteccao-visual');
            deteccoesExistentes.forEach(d => d.remove());
            
            const deteccao = document.createElement('div');
            deteccao.className = 'deteccao-visual';
            
            // Usa coordenadas diretas
            deteccao.style.position = 'absolute';
            deteccao.style.left = x + 'px';
            deteccao.style.top = y + 'px';
            deteccao.style.width = '15px';
            deteccao.style.height = '15px';
            deteccao.style.background = '#ff4444';
            deteccao.style.borderRadius = '50%';
            deteccao.style.border = '3px solid white';
            deteccao.style.boxShadow = '0 0 15px rgba(255,68,68,0.9)';
            deteccao.style.animation = 'pulse 1s infinite';
            deteccao.style.zIndex = '100';
            deteccao.title = `${tipo} - (${x}, ${y})`;
            
            // Adiciona label
            const label = document.createElement('div');
            label.style.position = 'absolute';
            label.style.left = '20px';
            label.style.top = '-8px';
            label.style.background = 'rgba(0,0,0,0.9)';
            label.style.color = 'white';
            label.style.padding = '4px 8px';
            label.style.borderRadius = '5px';
            label.style.fontSize = '11px';
            label.style.whiteSpace = 'nowrap';
            label.style.fontWeight = 'bold';
            label.textContent = tipo.replace('moto_', '').toUpperCase();
            deteccao.appendChild(label);
            
            mapa.appendChild(deteccao);
            deteccoesVisuais.push(deteccao);
            
            console.log(`‚úÖ Detec√ß√£o visual adicionada em (${x}, ${y}) - ${tipo}`);
            
            // Remove ap√≥s 10 segundos
            setTimeout(() => {
                if (deteccao.parentNode) {
                    deteccao.parentNode.removeChild(deteccao);
                    const index = deteccoesVisuais.indexOf(deteccao);
                    if (index > -1) deteccoesVisuais.splice(index, 1);
                }
            }, 10000);
        }

        function loadEvents() {
            console.log('üîÑ Carregando eventos...');
            
            fetch('/api/detections/recent')
                .then(response => {
                    console.log('üì° Resposta recebida:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ Dados recebidos:', data);
                    
                    const table = document.getElementById("eventTableBody");
                    const totalEvents = document.getElementById("totalEvents");
                    const lastUpdate = document.getElementById("lastUpdate");
                    
                    // Contadores por zona
                    const contadores = {
                        entrada: 0,
                        saida: 0,
                        estacionamento: 0,
                        manutencao: 0
                    };
                    
                    if (!data || data.length === 0) {
                        table.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    Nenhum evento de detec√ß√£o encontrado
                                </td>
                            </tr>
                        `;
                    } else {
                        table.innerHTML = "";
                        data.forEach((event, index) => {
                            console.log(`üìã Processando evento ${index + 1}:`, event);
                            
                            const zona = determinarZona(event.x, event.y);
                            const row = document.createElement('tr');
                            
                            // Determina cor do badge baseado no tipo
                            let badgeClass = 'info';
                            if (event.eventType === 'moto_entrou' || event.eventType === 'moto_entrada') badgeClass = 'success';
                            else if (event.eventType === 'moto_saiu' || event.eventType === 'moto_saida') badgeClass = 'danger';
                            else if (event.eventType === 'moto_estacionada' || event.eventType === 'moto_estacionamento') badgeClass = 'primary';
                            else if (event.eventType === 'moto_manutencao' || event.eventType === 'moto_manutencao') badgeClass = 'warning';
                            
                            // Formata timestamp
                            let timestampStr = 'N/A';
                            if (event.timestamp) {
                                try {
                                    timestampStr = new Date(event.timestamp).toLocaleString('pt-BR');
                                } catch (e) {
                                    timestampStr = event.timestamp.toString();
                                }
                            }
                            
                            row.innerHTML = `
                                <td>
                                    <span class="badge bg-${badgeClass}">
                                        ${event.eventType ? event.eventType.replace('moto_', 'Moto ').replace('_', ' ').toUpperCase() : 'DETECTADA'}
                                    </span>
                                </td>
                                <td>(${event.x || 0}, ${event.y || 0})</td>
                                <td><span class="badge bg-secondary">${zona}</span></td>
                                <td>${timestampStr}</td>
                            `;
                            table.appendChild(row);
                            
                            // Adiciona detec√ß√£o visual no mapa
                            adicionarDeteccaoVisual(event.x || 0, event.y || 0, event.eventType || 'moto_detectada');
                            
                            // Conta por zona
                            if (zona === 'Entrada') contadores.entrada++;
                            else if (zona === 'Sa√≠da') contadores.saida++;
                            else if (zona === 'Estacionamento') contadores.estacionamento++;
                            else if (zona === 'Manuten√ß√£o') contadores.manutencao++;
                        });
                    }
                    
                    // Atualiza estat√≠sticas
                    totalEvents.textContent = data ? data.length : 0;
                    lastUpdate.textContent = new Date().toLocaleString('pt-BR');
                    document.getElementById('entradaCount').textContent = contadores.entrada;
                    document.getElementById('saidaCount').textContent = contadores.saida;
                    document.getElementById('estacionamentoCount').textContent = contadores.estacionamento;
                    document.getElementById('manutencaoCount').textContent = contadores.manutencao;
                    
                    console.log('‚úÖ Eventos carregados com sucesso!');
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar eventos:', error);
                    const table = document.getElementById("eventTableBody");
                    table.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-danger">
                                Erro ao carregar eventos: ${error.message}
                            </td>
                        </tr>
                    `;
                    
                    // Atualiza estat√≠sticas mesmo com erro
                    document.getElementById('totalEvents').textContent = '0';
                    document.getElementById('lastUpdate').textContent = 'Erro';
                    document.getElementById('entradaCount').textContent = '0';
                    document.getElementById('saidaCount').textContent = '0';
                    document.getElementById('estacionamentoCount').textContent = '0';
                    document.getElementById('manutencaoCount').textContent = '0';
                });
        }

        function toggleAutoRefresh() {
            const button = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                isAutoRefreshEnabled = false;
                button.textContent = 'Auto Atualizar';
                button.parentElement.innerHTML = '<i class="fas fa-play me-1"></i>' + button.textContent;
            } else {
                autoRefreshInterval = setInterval(loadEvents, 3000);
                isAutoRefreshEnabled = true;
                button.textContent = 'Parar Auto';
                button.parentElement.innerHTML = '<i class="fas fa-pause me-1"></i>' + button.textContent;
            }
        }

        // Atualizar coordenadas do mouse no mapa
        document.getElementById('mapaDetecao').addEventListener('mousemove', function(e) {
            const rect = this.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (640 / rect.width));
            const y = Math.round((e.clientY - rect.top) * (480 / rect.height));
            document.getElementById('coordenadasMapa').textContent = `X: ${x}, Y: ${y}`;
        });

        // Carregar eventos quando a p√°gina carregar
        window.onload = function() {
            console.log('üöÄ P√°gina carregada, iniciando sistema...');
            loadEvents();
            
            // Inicia atualiza√ß√£o autom√°tica ap√≥s 2 segundos
            setTimeout(() => {
                console.log('üîÑ Iniciando atualiza√ß√£o autom√°tica...');
                toggleAutoRefresh();
            }, 2000);
        };
    </script>
    
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
    </style>
</body>

</html>
